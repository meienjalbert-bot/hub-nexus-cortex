services:
  meili:
    image: getmeili/meilisearch:v1.11
    ports: ["7700:7700"]
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_ENV=development
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-meili_key}
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:7700/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  qdrant:
    image: qdrant/qdrant:v1.10.1
    ports: ["6333:6333"]
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  ollama:
    image: ollama/ollama:latest
    profiles: ["ollama"]
    ports: ["11434:11434"]
    volumes:
      - ollama_models:/root/.ollama          # volume persistant (interne)
      - /srv/models-big:/models:ro           # tes GGUF
    environment:
      - OLLAMA_KEEP_ALIVE=5m
      - OLLAMA_NUM_PARALLEL=2
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 15s

  cortex:
    build:
      context: .
      dockerfile: apps/orchestrator/Dockerfile
    image: marland/cortex:devA
    ports: ["8100:8100"]
    environment:
      - MEILI_HOST=http://meili:7700
      - QDRANT_HOST=http://qdrant:6333
      - OLLAMA_BASE_URL=http://ollama:11434
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      meili: { condition: service_healthy }
      qdrant:{ condition: service_healthy }
      ollama:{ condition: service_healthy }
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8100/health"]
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 20s

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

volumes:
  ollama_models: {}

