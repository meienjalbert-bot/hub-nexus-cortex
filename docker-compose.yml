version: "3.9"

x-common-env: &common_env
  OLLAMA_HOST: ${OLLAMA_HOST-http://ollama:11434}
  OLLAMA_EMBED_MODEL: ${EMBED_MODEL-nomic-embed-text}
  QDRANT_HOST: ${QDRANT_HOST-http://qdrant:6333}
  QDRANT_COLLECTION: ${QDRANT_COLLECTION-nexus_docs}
  MEILI_HOST: ${MEILI_HOST-http://meili:7700}
  MEILI_INDEX: ${MEILI_INDEX-docs}

services:
  cortex:
    build: ./
    image: hub-nexus-cortex:local
    env_file:
      - configs/.env
    environment:
      <<: *common_env
      UVICORN_PORT: ${CORTEX_PORT-8100}
    ports: ["${CORTEX_PORT-8100}:8100"]
    command: >
      uvicorn apps.orchestrator.main:app --host 0.0.0.0 --port 8100
    profiles: ["cortex"]
    depends_on:
      - qdrant
      - meili
      - redis
      - neo4j
      - ollama

  qdrant:
    image: qdrant/qdrant:v1.11.0
    env_file:
      - configs/.env
    ports: ["${QDRANT_PORT-6333}:6333"]
    volumes:
      - qdrant_storage:/qdrant/storage
    profiles: ["deps"]

  meili:
    image: getmeili/meilisearch:v1.11
    env_file:
      - configs/.env
    environment:
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
    ports: ["${MEILI_PORT-7700}:7700"]
    volumes:
      - meili_data:/meili_data
    profiles: ["deps"]

  redis:
    image: redis/redis-stack:7.4.0-v0
    env_file:
      - configs/.env
    ports: ["${REDIS_PORT-6379}:6379", "${REDIS_UI-8001}:8001"]
    volumes:
      - redis_data:/data
    profiles: ["mesh"]

  neo4j:
    image: neo4j:5.24-community
    env_file:
      - configs/.env
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
    ports: ["${NEO4J_BOLT-7687}:7687", "${NEO4J_HTTP-7474}:7474"]
    volumes:
      - neo4j_data:/data
    profiles: ["mesh"]

  ollama:
    image: ollama/ollama:0.3.14
    env_file:
      - configs/.env
    volumes:
      - ollama_models:/root/.ollama
    ports: ["${OLLAMA_PORT-11434}:11434"]
    profiles: ["ollama"]
    command: ["serve"]

volumes:
  qdrant_storage: {}
  meili_data: {}
  redis_data: {}
  neo4j_data: {}
  ollama_models: {}
