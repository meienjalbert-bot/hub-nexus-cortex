services:
  meili:
    image: getmeili/meilisearch:v1.11
    restart: unless-stopped
    environment:
      MEILI_ENV: production
      MEILI_NO_ANALYTICS: 'true'
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-meili_key}
    volumes:
      - meili_data:/meili_data
    networks:
      nexus:
        aliases:
          - meili
  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      nexus:
        aliases:
          - qdrant
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      nexus:
        aliases:
          - redis
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    environment:
      OLLAMA_KEEP_ALIVE: 5m
      OLLAMA_NUM_PARALLEL: '1'
      OLLAMA_HOST: 0.0.0.0
    volumes:
      - ollama_models:/root/.ollama
      - /srv/models-big:/models:ro
    healthcheck:
      test:
        - CMD
        - curl
        - -sf
        - http://localhost:11434/api/tags
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      nexus:
        aliases:
          - ollama
    ports:
      - 11434:11434
  cortex:
    build:
      context: .
      dockerfile: apps/orchestrator/Dockerfile
    image: marland/cortex:devA
    restart: unless-stopped
    environment:
      PORT: ${CORTEX_PORT:-8100}
      MEILI_HOST: http://meili:7700
      QDRANT_HOST: http://qdrant:6333
      REDIS_URL: redis://redis:6379/0
      OLLAMA_BASE_URL: http://ollama:11434
      OLLAMA_DEFAULT_MODEL: qwen2.5-vl-7b-instruct:q4_k_m
      OLLAMA_SAGE_MODEL: qwen2.5-32b-instruct:q4_k_m
      ENABLE_SEMANTIC_CACHE: '1'
      LOUMINA_DB: /data/loumina.db
    volumes:
      - ./data/loumina:/data
    depends_on:
      meili:
        condition: service_started
      qdrant:
        condition: service_started
      ollama:
        condition: service_started
    ports:
      - 8100:8100
    networks:
      nexus: {}
volumes:
  meili_data: {}
  qdrant_data: {}
  ollama_models: {}
networks:
  nexus:
    external: true
    name: nexus
